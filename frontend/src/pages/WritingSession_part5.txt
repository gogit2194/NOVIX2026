                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-ink-500 tracking-wider">类别</label>
                                        <Input
                                            value={cardForm.category || ''}
                                            onChange={e => setCardForm(prev => ({ ...prev, category: e.target.value }))}
                                            placeholder="世界元素类别"
                                            className="bg-[var(--vscode-input-bg)]"
                                        />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-ink-500 tracking-wider">规则</label>
                                        <textarea
                                            className="w-full min-h-[140px] p-3 rounded-[6px] border border-[var(--vscode-input-border)] bg-[var(--vscode-input-bg)] text-sm focus:ring-1 focus:ring-[var(--vscode-focus-border)] resize-none overflow-hidden"
                                            value={cardForm.rules || ''}
                                            onChange={e => {
                                                setCardForm(prev => ({ ...prev, rules: e.target.value }));
                                                e.target.style.height = 'auto';
                                                e.target.style.height = e.target.scrollHeight + 'px';
                                            }}
                                            onFocus={e => {
                                                e.target.style.height = 'auto';
                                                e.target.style.height = e.target.scrollHeight + 'px';
                                            }}
                                            placeholder="每行一条规则"
                                        />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-ink-500 tracking-wider">不可变</label>
                                        <select
                                            value={cardForm.immutable}
                                            onChange={e => setCardForm(prev => ({ ...prev, immutable: e.target.value }))}
                                            className="w-full h-10 px-3 rounded-[6px] border border-[var(--vscode-input-border)] bg-[var(--vscode-input-bg)] text-sm focus:ring-1 focus:ring-[var(--vscode-focus-border)]"
                                        >
                                            <option value="unset">未设置</option>
                                            <option value="true">不可变</option>
                                            <option value="false">可变</option>
                                        </select>
                                    </div>
                                </>
                            )}

                            {/* Card Description */}
                            <div className="space-y-1">
                                <label className="text-xs font-bold text-ink-500 tracking-wider">描述</label>
                                <textarea
                                    className="w-full min-h-[200px] p-3 rounded-[6px] border border-[var(--vscode-input-border)] bg-[var(--vscode-input-bg)] text-sm focus:ring-1 focus:ring-[var(--vscode-focus-border)] resize-none overflow-hidden"
                                    value={cardForm.description || ''}
                                    onChange={e => {
                                        setCardForm(prev => ({ ...prev, description: e.target.value }));
                                        e.target.style.height = 'auto';
                                        e.target.style.height = e.target.scrollHeight + 'px';
                                    }}
                                    onFocus={e => {
                                        e.target.style.height = 'auto';
                                        e.target.style.height = e.target.scrollHeight + 'px';
                                    }}
                                    placeholder="请简要描述"
                                />
                            </div>

                        </div>
                    </motion.div>
                ) : !chapterInfo.chapter ? (
                    <motion.div
                        key="empty-state"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        className="h-[60vh] flex items-center justify-center"
                    >
                        <div className="text-center">
                            <div className="flex flex-col items-center gap-2 mb-4">
                                <span className="brand-logo text-4xl text-ink-900/40">文枢</span>
                            </div>
                            <p className="text-sm text-ink-500">
                                请在左侧选择资源，或使用快捷键 Cmd+B 切换面板
                            </p>
                        </div>
                    </motion.div>
                ) : (
                    <motion.div
                        key="chapter-editor"
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        exit={{ opacity: 0, y: -10 }}
                        transition={{ duration: 0.3 }}
                        className="h-full flex flex-col relative"
                    >
                        <div className="mb-4 pb-3 border-b border-border flex flex-wrap items-center gap-3">
                            <span className="text-[11px] font-mono text-ink-500 uppercase tracking-wider">{chapterInfo.chapter}</span>
                            <input
                                className="flex-1 min-w-[200px] bg-transparent text-2xl font-serif font-bold text-ink-900 outline-none placeholder:text-ink-300"
                                value={chapterInfo.chapter_title || ''}
                                onChange={(e) => {
                                    setChapterInfo((prev) => ({ ...prev, chapter_title: e.target.value }));
                                    dispatch({ type: 'SET_UNSAVED' });
                                }}
                                placeholder="请输入章节标题"
                                disabled={!chapterInfo.chapter}
                            />
                        </div>
                        <div className="flex-1 overflow-hidden bg-[var(--vscode-bg)] border-t border-[var(--vscode-sidebar-border)]">
                            {isDiffReviewForActiveChapter ? (
                                <DiffReviewView
                                    ops={diffReview.ops}
                                    hunks={diffReview.hunks}
                                    stats={diffReview.stats}
                                    decisions={diffDecisions}
                                    onAcceptHunk={handleAcceptDiffHunk}
                                    onRejectHunk={handleRejectDiffHunk}
                                    originalVersion="当前正文"
                                    revisedVersion="修改建议"
                                />
                            ) : isStreamingForActiveChapter ? (
                                <StreamingDraftView
                                    content={manualContent}
                                    active={isStreamingForActiveChapter}
                                    className="h-full"
                                />
                            ) : (
                                <textarea
                                    className="h-full w-full resize-none border-none outline-none bg-transparent p-6 text-base font-serif text-ink-900 leading-relaxed focus:ring-0 placeholder:text-ink-300 overflow-y-auto editor-scrollbar"
                                    value={manualContent}
                                    onChange={(e) => {
                                        const nextValue = e.target.value;
                                        setManualContent(nextValue);
                                        if (chapterInfo.chapter) {
                                            const key = String(chapterInfo.chapter);
                                            setManualContentByChapter((prev) => ({ ...(prev || {}), [key]: nextValue }));
                                        }
                                        dispatch({ type: 'SET_WORD_COUNT', payload: countChars(nextValue) });
                                        const stats = getSelectionStats(nextValue, e.target.selectionStart, e.target.selectionEnd);
                                        dispatch({ type: 'SET_SELECTION_COUNT', payload: stats.selectionCount });
                                        setSelectionInfo({
                                            start: stats.selectionStart,
                                            end: stats.selectionEnd,
                                            text: stats.selectionText || '',
                                        });
                                        const lines = stats.cursorText.split('\n');
                                        dispatch({
                                            type: 'SET_CURSOR_POSITION',
                                            payload: {
                                                line: lines.length,
                                                column: lines[lines.length - 1].length + 1
                                            }
                                        });
                                        dispatch({ type: 'SET_UNSAVED' });
                                    }}
                                    onSelect={(e) => {
                                        const stats = getSelectionStats(e.target.value, e.target.selectionStart, e.target.selectionEnd);
                                        dispatch({ type: 'SET_SELECTION_COUNT', payload: stats.selectionCount });
                                        setSelectionInfo({
                                            start: stats.selectionStart,
                                            end: stats.selectionEnd,
                                            text: stats.selectionText || '',
                                        });
                                        const lines = stats.cursorText.split('\n');
                                        dispatch({
                                            type: 'SET_CURSOR_POSITION',
                                            payload: {
                                                line: lines.length,
                                                column: lines[lines.length - 1].length + 1
                                            }
                                        });
                                    }}
                                    placeholder="开始写作..."
                                    disabled={!chapterInfo.chapter || lockedOnActiveChapter}
                                    spellCheck={false}
                                />
                            )}
                        </div>

                    </motion.div>
                )}
            </AnimatePresence>
        );
    };

    const rightPanelContent = (
        <AgentsPanel traceEvents={traceEvents} agentTraces={agentTraces}>
            <AgentStatusPanel
                mode={agentMode}
                onModeChange={setAgentMode}
                createDisabled={!canUseWriter}
                inputDisabled={agentBusy && String(aiLockedChapter || '') !== activeChapterKey}
                inputDisabledReason={
                    agentBusy && String(aiLockedChapter || '') !== activeChapterKey
                        ? `AI 正在撰写第 ${String(aiLockedChapter)} 章：右侧对话已锁定，请切换回该章节继续。`
                        : ''
                }
                selectionCandidateSummary={
                    agentMode === 'edit' && selectionInfo?.text?.trim()
                        ? `已选中 ${countChars(selectionInfo.text)} 字（未添加）`
                        : ''
                }
                selectionAttachedSummary={
                    agentMode === 'edit' && attachedSelection?.text?.trim()
                        ? `已添加选区 ${countChars(attachedSelection.text)} 字`
                        : ''
                }
                selectionCandidateDifferent={
                    Boolean(selectionInfo?.text?.trim()) &&
                    Boolean(attachedSelection?.text?.trim()) &&
                    (selectionInfo.start !== attachedSelection.start ||
                        selectionInfo.end !== attachedSelection.end ||
                        selectionInfo.text !== attachedSelection.text)
                }
                onAttachSelection={() => {
                    if (!selectionInfo?.text?.trim()) return;
                    setAttachedSelection({
                        start: selectionInfo.start,
                        end: selectionInfo.end,
                        text: selectionInfo.text,
                    });
                    setEditScope('selection');
                }}
                onClearAttachedSelection={() => {
                    setAttachedSelection(null);
                    setEditScope('document');
                }}
                editScope={editScope}
                onEditScopeChange={setEditScope}
                contextDebug={contextDebug}
                progressEvents={progressEvents}
                messages={messages}
                memoryPackStatus={memoryPackStatus}
                activeChapter={agentBusy ? aiLockedChapter : chapterInfo.chapter}
                editContextMode={editContextMode}
                onEditContextModeChange={setEditContextMode}
                diffReview={diffReview && String(diffReview?.chapterKey || '') === agentChapterKey ? diffReview : null}
                diffDecisions={diffDecisions}
                onAcceptAllDiff={handleAcceptAllDiff}
                onRejectAllDiff={handleRejectAllDiff}
                onApplySelectedDiff={handleApplySelectedDiff}
                onSubmit={(text) => {
                    if (!chapterInfo.chapter) {
                        addMessage('system', '请先选择章节。');
                        return;
                    }

                    if (agentMode === 'create') {
                        if (!canUseWriter) {
                            addMessage('system', '正文非空：主笔仅在正文为空时可用，请切换到编辑模式。');
                            setAgentMode('edit');
                            return;
                        }
                        addMessage('user', text);
                        handleStart(chapterInfo.chapter, 'deep', text);
                        return;
                    }

                    handleSubmitFeedback(text);
                }}
            />
        </AgentsPanel>
    );


    
    const saveBusy = isSaving || analysisLoading || analysisSaving;
    const showSaveAction = (chapterInfo.chapter || status === 'card_editing') && !lockedOnActiveChapter;
    const saveAction = showSaveAction ? (
        status === 'card_editing' ? (
            <Button
                onClick={handleCardSave}
                disabled={isSaving}
                className="shadow-sm"
                size="sm"
            >
                {isSaving ? '\u4fdd\u5b58\u4e2d...' : '\u4fdd\u5b58'}
            </Button>
        ) : (
            <SaveMenu
                disabled={!chapterInfo.chapter || saveBusy}
                busy={saveBusy}
                onSaveOnly={handleManualSave}
                onAnalyzeSave={handleAnalyzeAndSave}
            />
        )
    ) : null;

    const titleBarProps = {
        projectName: project?.name,
        rightActions: saveAction,
        // Show Card Name in Title if card editing
        chapterTitle: status === 'card_editing'
            ? cardForm.name
            : (chapterInfo.chapter ? (chapterInfo.chapter_title || `章节 ${chapterInfo.chapter}`) : null),
        aiHint: agentBusy && aiLockedChapter ? `正在撰写第 ${String(aiLockedChapter)} 章` : null,
    };

    return (
        <IDELayout rightPanelContent={rightPanelContent} titleBarProps={titleBarProps}>
            <div className="w-full h-full px-8 py-6">
                {renderMainContent()}
            </div>

            {notice ? (
                <div
                    key={notice.id}
                    className="fixed bottom-4 right-4 z-[60] max-w-[420px] rounded-[6px] border border-[var(--vscode-sidebar-border)] bg-[var(--vscode-input-bg)] px-3 py-2 text-xs text-[var(--vscode-fg)] shadow-md"
                >
                    {notice.text}
                </div>
            ) : null}


            <ChapterCreateDialog
                open={showChapterDialog}
                onClose={() => {
                    setShowChapterDialog(false);
                    dispatch({ type: 'CLOSE_CREATE_CHAPTER_DIALOG' });
                }}
                onConfirm={handleChapterCreate}
                existingChapters={chapters.map(c => ({ id: c, title: '' }))}
                volumes={volumes}
                defaultVolumeId={state.selectedVolumeId || 'V1'}
            />

            <PreWritingQuestionsDialog
                open={showPreWriteDialog}
                questions={preWriteQuestions}
                onConfirm={handlePreWriteConfirm}
                onSkip={handlePreWriteSkip}
            />

            <AnalysisReviewDialog
                open={analysisDialogOpen}
                analyses={analysisItems}
                onCancel={() => {
                    setAnalysisDialogOpen(false);
                    setAnalysisItems([]);
                }}
                onSave={handleSaveAnalysis}
                saving={analysisSaving}
            />

        </IDELayout >
    );
}

/**
 * WritingSession - 写作会话入口
 * 提供 IDE 上下文并渲染主容器。
 */
export default function WritingSession(props) {
    const { projectId } = useParams();
    return (
        <IDEProvider projectId={projectId}>
            <WritingSessionContent {...props} />
        </IDEProvider>
    );
}
